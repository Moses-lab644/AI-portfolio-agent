<!DOCTYPE html>

<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AI Portfolio Agent Onboarding</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#6D5BFF",
              "background-light": "#f5f6f8",
              "background-dark": "#101622",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
<style>
      .material-symbols-outlined {
        font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
      }
      .gradient-bg {
        background-image: radial-gradient(circle at top, #2A204A40, transparent 40%);
      }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex min-h-screen w-full flex-col items-center justify-center p-4 dark group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col items-center justify-center w-full max-w-2xl mx-auto py-12">
<!-- Progress Bar -->
<div class="w-full px-4 mb-12">
<div class="flex items-center justify-center">
<div class="flex flex-col items-center text-center">
<div class="flex items-center justify-center size-12 rounded-full bg-primary text-white font-bold z-10">
<span class="material-symbols-outlined" id="progressIcon">lock</span>
</div>
<p class="text-white text-sm font-medium mt-3" id="progressText">Connect 2+ Accounts</p>
</div>
</div>
</div>
<!-- Main Card -->
<div class="w-full rounded-xl bg-[#242428]/50 border border-white/10 shadow-2xl shadow-primary/10 overflow-hidden gradient-bg">
<div class="p-8">
<!-- Page Heading -->
<div class="flex flex-wrap justify-between gap-3 mb-8">
<div class="flex flex-col gap-2">
<p class="text-white text-xl font-black leading-tight tracking-tight">Build Your AI Portfolio Agent</p>
<p class="text-[#9ca6ba] text-base font-normal leading-normal">Share your details so your AI agent can represent you accurately to visitors.</p>
</div>
</div>

<!-- Tabs Navigation -->
<div class="flex gap-2 mb-6 border-b border-white/10">
<button class="tab-btn active px-4 py-2 text-white font-medium border-b-2 border-primary transition-colors" data-tab="details">
<span class="material-symbols-outlined text-sm mr-2" style="vertical-align: middle;">person</span>
Your Details
</button>
<button class="tab-btn px-4 py-2 text-[#9ca6ba] font-medium border-b-2 border-transparent hover:text-white transition-colors" data-tab="connections">
<span class="material-symbols-outlined text-sm mr-2" style="vertical-align: middle;">link</span>
Connections
</button>
</div>

<!-- Tab Content -->
<div class="w-full">
<!-- Details Tab -->
<div id="details-tab" class="tab-content space-y-4">
<!-- Professional Bio -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<label class="block text-white text-sm font-medium mb-2">Professional Bio</label>
<textarea id="professionalBio" placeholder="Brief summary of who you are and what you do" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary resize-none h-20"></textarea>
<p class="text-[#9ca6ba] text-xs mt-1">This helps your AI agent introduce you to visitors</p>
</div>

<!-- Skills -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<label class="block text-white text-sm font-medium mb-2">Key Skills (comma-separated)</label>
<input type="text" id="skills" placeholder="e.g., JavaScript, React, Python, Machine Learning, UI Design" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary">
<p class="text-[#9ca6ba] text-xs mt-1">What are you good at?</p>
</div>

<!-- Experience -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<label class="block text-white text-sm font-medium mb-2">Years of Experience</label>
<input type="number" id="yearsExperience" min="0" max="70" placeholder="e.g., 5" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary">
</div>

<!-- Specialties -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<label class="block text-white text-sm font-medium mb-2">Specialties (comma-separated)</label>
<input type="text" id="specialties" placeholder="e.g., Full-stack development, AI/ML, Cloud architecture" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary">
<p class="text-[#9ca6ba] text-xs mt-1">What areas do you specialize in?</p>
</div>

<!-- Current Role -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<label class="block text-white text-sm font-medium mb-2">Current Role/Title</label>
<input type="text" id="currentRole" placeholder="e.g., Senior Software Engineer, Product Designer" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary">
</div>

<!-- Save Details Button -->
<button id="saveDetailsBtn" class="w-full h-9 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors duration-200">
Save Your Details
</button>
</div>

<!-- Connections Tab -->
<div id="connections-tab" class="tab-content space-y-4 hidden">
<!-- GitHub Form -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<div class="flex items-center gap-4 mb-4">
<div class="text-white flex items-center justify-center rounded-lg bg-[#282e39] shrink-0 size-12">
<span class="material-symbols-outlined" style="font-size: 28px;">code</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-white text-base font-medium leading-normal">GitHub</p>
<p class="text-[#9ca6ba] text-sm font-normal leading-normal">Showcase your code and contributions.</p>
</div>
</div>
<form id="githubForm" class="space-y-3">
<input type="text" name="username" placeholder="GitHub username" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary" required>
<button type="submit" class="w-full h-9 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors duration-200">
Connect GitHub
</button>
</form>
</div>

<!-- LinkedIn Form -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<div class="flex items-center gap-4 mb-4">
<div class="text-white flex items-center justify-center rounded-lg bg-[#282e39] shrink-0 size-12">
<span class="material-symbols-outlined" style="font-size: 28px;">group</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-white text-base font-medium leading-normal">LinkedIn</p>
<p class="text-[#9ca6ba] text-sm font-normal leading-normal">Import your professional experience and network.</p>
</div>
</div>
<form id="linkedinForm" class="space-y-3">
<input type="url" name="profileUrl" placeholder="LinkedIn profile URL" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary" required>
<button type="submit" class="w-full h-9 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors duration-200">
Connect LinkedIn
</button>
</form>
</div>

<!-- Dribbble Form -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<div class="flex items-center gap-4 mb-4">
<div class="text-white flex items-center justify-center rounded-lg bg-[#282e39] shrink-0 size-12">
<span class="material-symbols-outlined" style="font-size: 28px;">palette</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-white text-base font-medium leading-normal">Dribbble</p>
<p class="text-[#9ca6ba] text-sm font-normal leading-normal">Display your design portfolio and creative work.</p>
</div>
</div>
<form id="dribbbleForm" class="space-y-3">
<input type="text" name="username" placeholder="Dribbble username" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary" required>
<button type="submit" class="w-full h-9 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors duration-200">
Connect Dribbble
</button>
</form>
</div>

<!-- Medium Form -->
<div class="bg-[#101622]/50 border border-white/10 rounded-lg p-4">
<div class="flex items-center gap-4 mb-4">
<div class="text-white flex items-center justify-center rounded-lg bg-[#282e39] shrink-0 size-12">
<span class="material-symbols-outlined" style="font-size: 28px;">article</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-white text-base font-medium leading-normal">Medium</p>
<p class="text-[#9ca6ba] text-sm font-normal leading-normal">Share your articles and thought leadership.</p>
</div>
</div>
<form id="mediumForm" class="space-y-3">
<input type="text" name="username" placeholder="Medium username" class="w-full px-3 py-2 bg-[#282e39] border border-white/10 rounded-lg text-white placeholder-[#9ca6ba] focus:outline-none focus:border-primary" required>
<button type="submit" class="w-full h-9 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors duration-200">
Connect Medium
</button>
</form>
</div>
</div>
</div>
<!-- Card Footer -->
<div class="bg-black/20 border-t border-white/10 p-6 flex justify-between items-center">
    <button id="skipBtn" class="text-[#9ca6ba] text-sm font-medium hover:text-white transition-colors duration-200">Skip for now</button>
    <button id="dashboardBtn" class="flex items-center justify-center rounded-lg h-10 px-6 bg-primary text-white text-sm font-bold leading-normal shadow-lg shadow-primary/20 transition-all duration-200 opacity-50 pointer-events-none" disabled>
        <span class="truncate">Continue to Dashboard</span>
        <span class="material-symbols-outlined ml-2">arrow_forward</span>
    </button>
</div>
</div>
</div>
</div>
<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active', 'text-white', 'border-primary');
            b.classList.add('text-[#9ca6ba]', 'border-transparent');
        });
        this.classList.add('active', 'text-white', 'border-primary');
        this.classList.remove('text-[#9ca6ba]', 'border-transparent');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        document.getElementById(tabName + '-tab').classList.remove('hidden');
    });
});

// Save user details
document.getElementById('saveDetailsBtn').addEventListener('click', async function() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        alert('Please log in first');
        return;
    }
    
    const details = {
        professionalBio: document.getElementById('professionalBio').value,
        skills: document.getElementById('skills').value.split(',').map(s => s.trim()).filter(s => s),
        yearsExperience: parseInt(document.getElementById('yearsExperience').value) || 0,
        specialties: document.getElementById('specialties').value.split(',').map(s => s.trim()).filter(s => s),
        currentRole: document.getElementById('currentRole').value
    };
    
    try {
        const response = await fetch('/api/user/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(details)
        });
        
        if (response.ok) {
            alert('✓ Your details have been saved!');
            // Store in localStorage for quick access
            localStorage.setItem('userDetails', JSON.stringify(details));
        } else {
            alert('Failed to save details');
        }
    } catch (error) {
        console.error('Error saving details:', error);
        alert('Error saving details');
    }
});

// Check authentication on page load
function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        window.location.href = '/login.html';
        return;
    }
    
    // Verify token is still valid
    fetch('/api/auth/verify', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            window.location.href = '/login.html';
        }
    })
    .catch(error => {
        console.error('Auth verification failed:', error);
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        window.location.href = '/login.html';
    });
}

// Handle form submissions
function handlePlatformConnection(platform, formData) {
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        alert('Authentication token not found. Please log in again.');
        return;
    }
    
    if (!formData.username && !formData.profileUrl) {
        alert('Please provide required information');
        return;
    }
    
    fetch(`/api/portfolio/connect/${platform}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success message and update UI
            const form = document.getElementById(`${platform}Form`);
            form.innerHTML = `<div class="flex items-center gap-2 text-[#03DAC6] justify-center py-2">
                <span class="material-symbols-outlined">check_circle</span>
                <span class="text-sm font-medium">Connected</span>
            </div>`;
            // Persist connection state and update button
            try {
                const stored = JSON.parse(localStorage.getItem('connectedPlatforms') || '[]');
                if (!stored.includes(platform)) {
                    stored.push(platform);
                    localStorage.setItem('connectedPlatforms', JSON.stringify(stored));
                }
            } catch (e) {
                localStorage.setItem('connectedPlatforms', JSON.stringify([platform]));
            }
            // Store notification
            try {
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                notifications.unshift({
                    id: Date.now(),
                    message: `Successfully connected ${platform}!`,
                    type: 'success',
                    timestamp: new Date().toISOString(),
                    read: false
                });
                localStorage.setItem('notifications', JSON.stringify(notifications.slice(0, 10)));
            } catch (e) {
                console.error('Failed to store notification:', e);
            }
            // Show alert
            alert(`✓ Successfully connected ${platform}!`);
            // Update button state after connection
            if (typeof updateButtonState === 'function') {
                updateButtonState();
            }
        } else {
            alert(`Failed to connect ${platform}: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(error => {
        console.error(`Error connecting ${platform}:`, error);
        alert(`Error connecting ${platform}: ${error.message}`);
    });
}

// Form event listeners
document.addEventListener('DOMContentLoaded', function() {
    // GitHub form
    document.getElementById('githubForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        handlePlatformConnection('github', {
            username: formData.get('username')
        });
    });
    
    // LinkedIn form
    document.getElementById('linkedinForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        handlePlatformConnection('linkedin', {
            profileUrl: formData.get('profileUrl')
        });
    });
    
    // Dribbble form
    document.getElementById('dribbbleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        handlePlatformConnection('dribbble', {
            username: formData.get('username')
        });
    });
    
    // Medium form
    document.getElementById('mediumForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        handlePlatformConnection('medium', {
            username: formData.get('username')
        });
    });

    // Initialize connected platforms from localStorage and update UI
    const existing = JSON.parse(localStorage.getItem('connectedPlatforms') || '[]');
    if (Array.isArray(existing) && existing.length > 0) {
        existing.forEach(p => markConnectedUI(p));
    }

    // Attempt to fetch connected platforms from server (authoritative)
    (async function checkServerConnectedPlatforms() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            return;
        }
        try {
            const res = await fetch('/api/portfolio', { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) { return; }
            const data = await res.json();
            let platforms = [];
            if (Array.isArray(data)) platforms = data;
            else if (data && Array.isArray(data.connected)) platforms = data.connected;
            if (platforms.length > 0) {
                // Persist server-known connections locally for quick access
                try { localStorage.setItem('connectedPlatforms', JSON.stringify(platforms)); } catch (e) {}
                platforms.forEach(p => markConnectedUI(p));
            }
        } catch (e) {
            console.warn('Could not fetch connected platforms from server:', e);
        }
    })();

    // Update button state based on connected platform count
    function updateButtonState() {
        const existing = JSON.parse(localStorage.getItem('connectedPlatforms') || '[]');
        const count = Array.isArray(existing) ? existing.length : 0;
        const dashboardBtn = document.getElementById('dashboardBtn');
        const progressIcon = document.getElementById('progressIcon');
        const progressText = document.getElementById('progressText');
        
        if (count >= 2) {
            dashboardBtn.removeAttribute('disabled');
            dashboardBtn.classList.remove('opacity-50', 'pointer-events-none');
            dashboardBtn.classList.add('hover:bg-primary/90');
            progressIcon.textContent = 'check';
            progressText.textContent = 'All Set!';
        } else {
            dashboardBtn.setAttribute('disabled', 'disabled');
            dashboardBtn.classList.add('opacity-50', 'pointer-events-none');
            dashboardBtn.classList.remove('hover:bg-primary/90');
            progressIcon.textContent = 'lock';
            progressText.textContent = `Connect ${2 - count} more account${2 - count === 1 ? '' : 's'}`;
        }
    }

    // Bind dashboard button - requires 2+ accounts
    const dashboardBtn = document.getElementById('dashboardBtn');
    dashboardBtn.addEventListener('click', () => {
        const existing = JSON.parse(localStorage.getItem('connectedPlatforms') || '[]');
        if (Array.isArray(existing) && existing.length >= 2) {
            window.location.href = '/dashboard.html';
        }
    });

    // Bind skip button
    const skipBtn = document.getElementById('skipBtn');
    skipBtn.addEventListener('click', () => {
        try { localStorage.setItem('onboardingSkipped', 'true'); } catch (e) { /* ignore */ }
        window.location.href = '/dashboard.html';
    });

    // Initialize button state
    updateButtonState();
});

// Mark a platform's form as connected (used on success and on load)
function markConnectedUI(platform) {
    const form = document.getElementById(`${platform}Form`);
    if (form) {
        form.innerHTML = `<div class="flex items-center gap-2 text-[#03DAC6] justify-center py-2">
                <span class="material-symbols-outlined">check_circle</span>
                <span class="text-sm font-medium">Connected</span>
            </div>`;
    }
}

// Run auth check when page loads
checkAuth();
</script>
</body></html>
